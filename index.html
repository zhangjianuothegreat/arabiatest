<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WelfareCalc.ch – حسابك</title>
  <!-- 稳定 Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap');
    body { font-family: 'Noto Sans Arabic', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
  <div class="container mx-auto p-6 max-w-4xl" dir="rtl">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-green-700">حسابك</h1>
    </div>

    <!-- 输入表单 -->
    <div id="input-form" class="bg-white rounded-2xl shadow-xl p-8 mb-8"></div>

    <!-- 计算按钮 -->
    <button id="calc-btn" disabled class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold text-xl mb-8 opacity-50 cursor-not-allowed">
      احسب!
    </button>

    <!-- 结果区 -->
    <div id="result" class="hidden">
      <div class="bg-green-50 rounded-2xl p-8 mb-6">
        <h2 class="text-3xl font-bold text-green-700 text-center mb-6">
          يمكنك الحصول على حوالي <span id="total-amount" class="text-5xl">0</span> فرنك سويسري/سنة!
        </h2>
        <div id="breakdown-list" class="space-y-6 mb-8"></div>
        <canvas id="chart" class="mx-auto max-w-md"></canvas>
      </div>
      <div class="text-center space-x-4">
        <button id="share-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">مشاركة & تنزيل PDF</button>
        <button id="ad-btn" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700">مشاهدة الإعلان & PDF</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const { jsPDF } = window.jspdf;

      // --- URL 参数 ---
      const urlParams = new URLSearchParams(window.location.search);
      let canton = urlParams.get('c') || 'ZH';

      // --- 输入配置 ---
      const inputsConfig = [
        { id: "income", label: "دخل الأسرة الشهري (فرنك سويسري)", type: "number", placeholder: "مثال 4000" },
        { id: "kids", label: "عدد الأطفال (0–16 عاماً)", type: "number", placeholder: "مثال 2" },
        { id: "kids_education", label: "عدد الأطفال في التعليم (>16 عاماً)", type: "number", placeholder: "مثال 0" },
        { id: "plz", label: "الرمز البريدي", type: "text", placeholder: "مثال 1000" },
        { id: "rent", label: "الإيجار الشهري (فرنك سويسري)", type: "number", placeholder: "مثال 1500" },
        { id: "premium_adult", label: "قسط البالغ الشهري", type: "number", placeholder: "مثال 500" }
      ];

      // --- 渲染输入 ---
      const form = document.getElementById('input-form');
      form.innerHTML = inputsConfig.map(f => `
        <div class="mb-6">
          <label class="block text-lg font-semibold mb-2">${f.label}</label>
          <input id="${f.id}" type="${f.type}" class="w-full p-3 border rounded-lg text-lg" placeholder="${f.placeholder}">
        </div>
      `).join('');
      document.getElementById('calc-btn').onclick = calculate;

      // --- 启用按钮 ---
      form.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => {
          const allFilled = Array.from(form.querySelectorAll('input')).every(i => i.value.trim());
          const btn = document.getElementById('calc-btn');
          btn.disabled = !allFilled;
          btn.classList.toggle('opacity-50', !allFilled);
          btn.classList.toggle('cursor-not-allowed', !allFilled);
        });
      });

      // --- 26州数据（完整无截断）---
      const federal = { child: 215, education: 268 };
      const cantons = {
        "AG": { bonus: 0, praemien: { threshold: 65000, rate: 0.16, child_bonus: 108.33, ref: 456, max: 400 }, wohn: { max: 1600, rate: 0.3 }, links: { p: "ag.ch/praemienverbilligung", w: "ag.ch/sozialhilfe" } },
        "AI": { bonus: 30, praemien: { threshold: 70000, rate: 0.07, child_bonus: 100, ref: 456, max: 350 }, wohn: { max: 1400, rate: 0.3 }, links: { p: "ai.ch/praemienverbilligung", w: "ai.ch/sozialhilfe" } },
        "AR": { bonus: 15, praemien: { threshold: 46200, rate: 0.42, child_bonus: 104, ref: 456, max: 300 }, wohn: { max: 1500, rate: 0.3 }, links: { p: "ar.ch/praemienverbilligung", w: "ar.ch/sozialhilfe" } },
        "BE": { bonus: 35, praemien: { threshold: 65000, rate: 0.1, child_bonus: 211, ref: 456, max: 2529.6/12 }, wohn: { max: 1550, rate: 0.3 }, links: { p: "be.ch/praemienverbilligung", w: "be.ch/sozialhilfe" } },
        "BL": { bonus: 0, praemien: { threshold: 75000, rate: 0.0775, child_bonus: 108.33, ref: 456, max: 400 }, wohn: { max: 1600, rate: 0.3 }, links: { p: "bl.ch/praemienverbilligung", w: "bl.ch/sozialhilfe" } },
        "BS": { bonus: 60, praemien: { threshold: 107000, rate: 0.08, child_bonus: 271, ref: 456, max: 431 }, wohn: { max: 1700, rate: 0.3 }, links: { p: "bs.ch/praemienverbilligung", w: "bs.ch/sozialhilfe" } },
        "FR": { bonus: 50, praemien: { threshold: 65000, rate: 0.01, child_bonus: 125, ref: 456, max: 500 }, wohn: { max: 1500, rate: 0.3 }, links: { p: "fr.ch/praemienverbilligung", w: "fr.ch/sozialhilfe" } },
        "GE": { bonus: 96, praemien: { threshold: 115000, rate: 0.1, child_bonus: 200, ref: 456, max: 600 }, wohn: { max: 1800, rate: 0.3 }, links: { p: "ge.ch/praemienverbilligung", w: "ge.ch/sozialhilfe" } },
        "GL": { bonus: 0, praemien: { threshold: 100000, rate: 0.09, child_bonus: 108.33, ref: 456, max: 400 }, wohn: { max: 1400, rate: 0.3 }, links: { p: "gl.ch/praemienverbilligung", w: "gl.ch/sozialhilfe" } },
        "GR": { bonus: 15, praemien: { threshold: 60000, rate: 0.05, child_bonus: 108.33, ref: 456, max: 350 }, wohn: { max: 1500, rate: 0.3 }, links: { p: "gr.ch/praemienverbilligung", w: "gr.ch/sozialhilfe" } },
        "JU": { bonus: 60, praemien: { threshold: 53000, rate: 0.4, child_bonus: 100, ref: 456, max: 300 }, wohn: { max: 1300, rate: 0.3 }, links: { p: "ju.ch/praemienverbilligung", w: "ju.ch/sozialhilfe" } },
        "LU": { bonus: 45, praemien: { threshold: 70000, rate: 0.1, child_bonus: 108.33, ref: 456, max: 400 }, wohn: { max: 1550, rate: 0.3 }, links: { p: "lu.ch/praemienverbilligung", w: "lu.ch/sozialhilfe" } },
        "NE": { bonus: 25, praemien: { threshold: 50000, rate: 0.07, child_bonus: 100, ref: 456, max: 350 }, wohn: { max: 1400, rate: 0.3 }, links: { p: "ne.ch/praemienverbilligung", w: "ne.ch/sozialhilfe" } },
        "NW": { bonus: 43, praemien: { threshold: 60000, rate: 0.1, child_bonus: 108.33, ref: 456, max: 300 }, wohn: { max: 1300, rate: 0.3 }, links: { p: "nw.ch/praemienverbilligung", w: "nw.ch/sozialhilfe" } },
        "OW": { bonus: 5, praemien: { threshold: 70000, rate: 0.1, child_bonus: 108.33, ref: 456, max: 350 }, wohn: { max: 1400, rate: 0.3 }, links: { p: "ow.ch/praemienverbilligung", w: "ow.ch/sozialhilfe" } },
        "SG": { bonus: 30, praemien: { threshold: 60500, rate: 0.1135, child_bonus: 100, ref: 456, max: 400 }, wohn: { max: 1550, rate: 0.3 }, links: { p: "sg.ch/praemienverbilligung", w: "sg.ch/sozialhilfe" } },
        "SH": { bonus: 30, praemien: { threshold: 65000, rate: 0.15, child_bonus: 108.33, ref: 456, max: 400 }, wohn: { max: 1600, rate: 0.3 }, links: { p: "sh.ch/praemienverbilligung", w: "sh.ch/sozialhilfe" } },
        "SO": { bonus: 0, praemien: { threshold: 100000, rate: 0.09, child_bonus: 108.33, ref: 456, max: 400 }, wohn: { max: 1500, rate: 0.3 }, links: { p: "so.ch/praemienverbilligung", w: "so.ch/sozialhilfe" } },
        "SZ": { bonus: 15, praemien: { threshold: 43014, rate: 0.11, child_bonus: 200, ref: 456, max: 200 }, wohn: { max: 1550, rate: 0.3 }, links: { p: "sz.ch/praemienverbilligung", w: "sz.ch/sozialhilfe" } },
        "TG": { bonus: 0, praemien: { threshold: 70000, rate: 0.1, child_bonus: 100, ref: 456, max: 3396/12 }, wohn: { max: 1500, rate: 0.3 }, links: { p: "tg.ch/praemienverbilligung", w: "tg.ch/sozialhilfe" } },
        "TI": { bonus: 0, praemien: { threshold: 51560, rate: 0.1, child_bonus: 489.5, ref: 456, max: 489.5 }, wohn: { max: 1600, rate: 0.3 }, links: { p: "ti.ch/praemienverbilligung", w: "ti.ch/sozialhilfe" } },
        "UR": { bonus: 25, praemien: { threshold: 70000, rate: 0.0975, child_bonus: 108.33, ref: 456, max: 350 }, wohn: { max: 1400, rate: 0.3 }, links: { p: "ur.ch/praemienverbilligung", w: "ur.ch/sozialhilfe" } },
        "VD": { bonus: 107, praemien: { threshold: 72500, rate: 0.08, child_bonus: 28, ref: 456, max: 28 }, wohn: { max: 1700, rate: 0.3 }, links: { p: "vd.ch/praemienverbilligung", w: "vd.ch/sozialhilfe" } },
        "VS": { bonus: 112, praemien: { threshold: 36750, rate: 0.07, child_bonus: 100, ref: 456, max: 400 }, wohn: { max: 1600, rate: 0.3 }, links: { p: "vs.ch/praemienverbilligung", w: "vs.ch/sozialhilfe" } },
        "ZG": { bonus: 115, praemien: { threshold: 90000, rate: 0.08, child_bonus: 108.33, ref: 456, max: 400 }, wohn: { max: 1800, rate: 0.3 }, links: { p: "zg.ch/praemienverbilligung", w: "zg.ch/sozialhilfe" } },
        "ZH": { bonus: 0, praemien: { threshold: 88580, rate: 0.1, child_bonus: 150, ref: 456, max: 400 }, wohn: { max: 1700, rate: 0.3 }, links: { p: "svazurich.ch/praemienverbilligung", w: "zh.ch/sozialhilfe" } }
      };

      let total = 0, breakdown = {}, inputs = {};

      // --- 计算 ---
      window.calculate = () => {
        inputs = {
          income: +document.getElementById('income').value,
          kids: +document.getElementById('kids').value,
          kids_education: +document.getElementById('kids_education').value,
          plz: document.getElementById('plz').value,
          rent: +document.getElementById('rent').value,
          premium_adult: +document.getElementById('premium_adult').value
        };
        if (inputs.plz.length !== 4 || isNaN(+inputs.plz)) return alert("الرمز البريدي يجب أن يكون 4 أرقام!");

        const c = cantons[canton] || cantons.ZH;
        const family = ((federal.child + c.bonus) * inputs.kids + federal.education * inputs.kids_education) * 12;
        const children = inputs.kids + inputs.kids_education;
        const premiumCalc = c.praemien.ref - (inputs.income * c.praemien.rate) + (c.praemien.child_bonus * children);
        const premium = Math.max(0, Math.min(premiumCalc, c.praemien.max)) * 12;
        const cappedRent = Math.min(inputs.rent, c.wohn.max);
        const housing = Math.max(0, cappedRent - inputs.income * c.wohn.rate) * 12;

        breakdown = { 'بدل العائلة': family, 'تخفيض القسط': premium, 'مساعدة السكن': housing };
        total = family + premium + housing;

        document.getElementById('total-amount').textContent = Math.round(total).toLocaleString();
        document.getElementById('result').classList.remove('hidden');
        renderBreakdown();
        renderChart();
      };

      function renderBreakdown() {
        document.getElementById('breakdown-list').innerHTML = Object.entries(breakdown)
          .filter(([_, v]) => v > 0)
          .map(([k, v]) => `<div class="text-lg"><strong>${k}</strong>: ${v.toLocaleString()} فرنك/سنة</div>`)
          .join('');
      }

      function renderChart() {
        new Chart(document.getElementById('chart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(breakdown).filter(k => breakdown[k] > 0),
            datasets: [{ data: Object.values(breakdown).filter(v => v > 0), backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'] }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      }

      // --- PDF 生成（无字体加载，直接用系统字体 + RTL）---
      window.generatePDF = () => {
        const doc = new jsPDF();
        const c = cantons[canton] || cantons.ZH;
        doc.setFontSize(16);
        doc.text("تقرير المساعدات الاجتماعية", 105, 20, { align: 'center' });
        doc.setFontSize(11);
        doc.text(`الكانتون: ${canton} | التاريخ: ${new Date().toLocaleDateString('ar')}`, 195, 35, { align: 'right' });
        doc.setFontSize(14);
        doc.text(`الإجمالي: ${Math.round(total).toLocaleString()} فرنك/سنة`, 195, 50, { align: 'right' });

        const tableData = Object.entries(breakdown).filter(([_, v]) => v > 0).map(([k, v]) => [k, `${v.toLocaleString()} فرنك/سنة`, '']);
        doc.autoTable({
          head: [['البند', 'المبلغ', 'الصيغة']],
          body: tableData,
          startY: 60,
          styles: { fontSize: 10, halign: 'right' },
          headStyles: { fillColor: [34, 139, 34] }
        });

        doc.save(`WelfareCalc-${canton}.pdf`);
      };

      // --- 分享 ---
      let sharing = false;
      window.shareToUnlock = () => {
        if (sharing) return;
        sharing = true;
        if (navigator.share) {
          navigator.share({ title: 'WelfareCalc', text: `حصلت على ${Math.round(total)} فرنك!`, url: location.href })
            .finally(() => { sharing = false; setTimeout(generatePDF, 500); });
        } else { sharing = false; generatePDF(); }
      };

      // --- 广告 ---
      window.showAdThenPDF = () => {
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        overlay.innerHTML = `<div class="bg-white p-8 rounded-xl text-center"><h3 class="text-xl font-bold mb-4">إعلان (5 ثوان)</h3><div class="bg-gray-200 border-2 border-dashed w-64 h-40 mb-4"></div><p>قابل للإغلاق خلال <span id="countdown" class="font-bold text-orange-600">5</span> ثوان</p></div>`;
        document.body.appendChild(overlay);
        let sec = 5;
        const el = overlay.querySelector('#countdown');
        const timer = setInterval(() => {
          sec--;
          el.textContent = sec;
          if (sec <= 0) { clearInterval(timer); overlay.remove(); generatePDF(); }
        }, 1000);
      };

      document.getElementById('share-btn').onclick = shareToUnlock;
      document.getElementById('ad-btn').onclick = showAdThenPDF;
    });
  </script>
</body>
</html>
